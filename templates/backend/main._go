package main

import (
	"fmt"

	"github.com/gin-gonic/gin"
	"github.com/jinzhu/gorm"
	_ "github.com/jinzhu/gorm/dialects/mysql"  //
	_ "github.com/jinzhu/gorm/dialects/sqlite" //
	"{{PackagePath}}/controller"
	"{{PackagePath}}/dao"
	"{{PackagePath}}/service"
	"{{PackagePath}}/utils/config"
	"{{PackagePath}}/utils/log"
	"{{PackagePath}}/utils/transaction"
)

func main() {

	log.GetLog().WithFile("{{AppName}}", 14)

	log.GetLog().Info("main", "Apps run")

	cf := config.NewSimpleConfig("config", "$GOPATH/src/{{PackagePath}}")

	db, err := gorm.Open(cf.GetString("database.dialect", "sqlite3"), cf.GetString("database.connection_string", "database.db"))
	if err != nil {
		panic(err)
	}
	db.LogMode(true)

	router := gin.Default()

	trx := transaction.NewGormTransactionDB(db)

	{{range .Entities}}	
	{{CamelCase .Name}}Dao := dao.New{{PascalCase .Name}}Dao(db)	
	{{end}}

	{{range .Entities}}
	{{CamelCase .Name}}Service := service.New{{PascalCase .Name}}Service(trx, {{CamelCase .Name}}Dao)
	{{end}}

	rc := RouterConfig{
		router:                       router, {{range .Entities}}
		productionTemplateController: controller.New{{PascalCase .Name}}Controller({{CamelCase .Name}}Service), {{end}}
	}

	rc.UseCors()
	rc.Setup()	

	router.Run(fmt.Sprintf(":%d", cf.GetInt("server.port", "8081")))

}
