package controller

import (
	"fmt"
	"net/http"
	"strconv"

	"github.com/gin-gonic/gin"
	"{{PackagePath}}/model"
	"{{PackagePath}}/model/basic"
	"{{PackagePath}}/service"
	"{{PackagePath}}/utils/common"
	"{{PackagePath}}/utils/log"
)

// {{PascalCase .Name}}Controller is
type {{PascalCase .Name}}Controller struct {
	{{CamelCase .Name}}Service service.I{{PascalCase .Name}}Service
}

// New{{PascalCase .Name}}Controller is
func New{{PascalCase .Name}}Controller({{CamelCase .Name}}Service service.I{{PascalCase .Name}}Service) *{{PascalCase .Name}}Controller {

	c := {{PascalCase .Name}}Controller{
		{{CamelCase .Name}}Service: {{CamelCase .Name}}Service,
	}

	return &c
}

// Create is
func (g *{{PascalCase .Name}}Controller) Create(c *gin.Context) {

	logInfo := log.Data{
		ClientIP: c.ClientIP(),
		Session:  common.GetShortUniqueID(),
		Type:     "API",
	}

	var dto model.Create{{PascalCase .Name}}Request
	if err := c.BindJSON(&dto); err != nil {
		log.GetLog().Error(logInfo, "%v", err.Error())
		c.JSON(http.StatusBadRequest, map[string]interface{}{"message": "Invalid Params. Please check data structure and type"})		
		return
	}

	log.GetLog().Info(logInfo, "Request. Data %v", common.GetJSON(dto))

	sc := map[string]interface{}{
		"logInfo": logInfo,
	}

	obj, err := g.{{CamelCase .Name}}Service.Create(sc, dto)
	if err != nil {
		message := log.GetLog().Error(logInfo, "%v", err.Error())
		c.JSON(http.StatusBadRequest, map[string]interface{}{"message": message})
		return
	}

	message := log.GetLog().Info(logInfo, "Response. ID %v created", obj.ID)
	c.JSON(http.StatusCreated, map[string]interface{}{"message": message})
}

// GetOne is
func (g *{{PascalCase .Name}}Controller) GetOne(c *gin.Context) {

	logInfo := log.Data{
		ClientIP: c.ClientIP(),
		Session:  common.GetShortUniqueID(),
		Type:     "API",
	}

	id := c.Param("{{CamelCase .Name}}ID")

	log.GetLog().Info(logInfo, "Request. ID %v", id)

	sc := map[string]interface{}{
		"logInfo": logInfo,
	}

	idInt, err := strconv.ParseUint(id, 10, 32)
	if err != nil {
		message := log.GetLog().Error(logInfo, "id must integer")
		c.JSON(http.StatusBadRequest, map[string]interface{}{"message": message})
		return
	}

	obj := g.{{CamelCase .Name}}Service.GetOne(sc, uint(idInt))
	if obj == nil {
		message := log.GetLog().Info(logInfo, "No record found with id %v", id)
		c.JSON(http.StatusOK, map[string]interface{}{"message": message})
		return
	}

	message := log.GetLog().Info(logInfo, "Response. ID %v found", id)
	c.JSON(http.StatusOK, map[string]interface{}{"message": message, "data": obj})
}

// GetAll is
func (g *{{PascalCase .Name}}Controller) GetAll(c *gin.Context) {

	logInfo := log.Data{
		ClientIP: c.ClientIP(),
		Session:  common.GetShortUniqueID(),
		Type:     "API",
	}

	pageStr := c.DefaultQuery("page", "1")
	page, err := strconv.Atoi(pageStr)
	if err != nil || page < 1 {
		page = 1
	}

	sizeStr := c.DefaultQuery("size", "30")
	size, err := strconv.Atoi(sizeStr)
	if err != nil || (size < 1 && size > 100) {
		size = 1
	}


	sortBy := c.DefaultQuery("sortBy", "")
	sortDescString := c.DefaultQuery("sortDesc", "false")

	sortDesc, err := strconv.ParseBool(sortDescString)
	if err != nil {
		message := "sortDesc must bool"
		c.JSON(http.StatusBadRequest, map[string]interface{}{"message": message, "data": []interface{}{}})
		return
	}

	filters := map[string]string{}

	listField := []string{ {{range .Fields}}
		"{{CamelCase .Name}}", {{end}}
	}

	for _, field := range listField {
		if query := c.DefaultQuery("f_"+field, ""); query != "" {
			filters[field] = query
		}
	}	

	log.GetLog().Info(logInfo, "Request. Page %v, size %v, filter %v", page, size, common.GetJSON(filters))	

	sc := map[string]interface{}{
		"logInfo": logInfo,
	}	

	req := basic.GetAllCommonRequest{
		Filters:  filters,
		Page:     page,
		Size:     size,
		SortBy:   sortBy,
		SortDesc: sortDesc,
	}	

	objs := g.{{CamelCase .Name}}Service.GetAll(sc, req)

	message := log.GetLog().Info(logInfo, "Response. Success with total %v", objs.TotalCount)
	c.JSON(http.StatusOK, map[string]interface{}{"message": message, "data": objs})
}

// Update is
func (g *{{PascalCase .Name}}Controller) Update(c *gin.Context) {

	logInfo := log.Data{
		ClientIP: c.ClientIP(),
		Session:  common.GetShortUniqueID(),
		Type:     "API",
	}

	id := c.Param("{{CamelCase .Name}}ID")

	idInt, err := strconv.ParseUint(id, 10, 32)
	if err != nil {
		message := log.GetLog().Error(logInfo, "id must integer")
		c.JSON(http.StatusBadRequest, map[string]interface{}{"message": message})
		return
	}

	var dto model.Update{{PascalCase .Name}}Request
	if err := c.BindJSON(&dto); err != nil {
		log.GetLog().Error(logInfo, "%v", err.Error())
		c.JSON(http.StatusBadRequest, map[string]interface{}{"message": fmt.Sprintf("Invalid Params. Please check data structure and type")})
		return
	}

	log.GetLog().Info(logInfo, "Request. ID %v, data %v", id, common.GetJSON(dto))

	sc := map[string]interface{}{
		"logInfo": logInfo,
	}

	_, err = g.{{CamelCase .Name}}Service.Update(sc, uint(idInt), dto)
	if err != nil {
		message := log.GetLog().Error(logInfo, "%v", err.Error())
		c.JSON(http.StatusBadRequest, map[string]interface{}{"message": message})
		return
	}

	message := log.GetLog().Info(logInfo, "Response. ID %v updated", id)
	c.JSON(http.StatusOK, map[string]interface{}{"message": message})

}

// Delete is
func (g *{{PascalCase .Name}}Controller) Delete(c *gin.Context) {

	logInfo := log.Data{
		ClientIP: c.ClientIP(),
		Session:  common.GetShortUniqueID(),
		Type:     "API",
	}

	id := c.Param("{{CamelCase .Name}}ID")

	log.GetLog().Info(logInfo, "Request. ID %v", id)

	sc := map[string]interface{}{
		"logInfo": logInfo,
	}

	idInt, err := strconv.ParseUint(id, 10, 32)
	if err != nil {
		message := log.GetLog().Error(logInfo, "id must integer")
		c.JSON(http.StatusBadRequest, map[string]interface{}{"message": message})
		return
	}
	
	_, err = g.{{CamelCase .Name}}Service.Delete(sc, uint(idInt))
	if err != nil {
		log.GetLog().Error(logInfo, "%v", err.Error())
		c.JSON(http.StatusBadRequest, map[string]interface{}{"message": fmt.Sprintf("Error when delete record with ID %v", id)})
		return
	}

	message := log.GetLog().Info(logInfo, "Response. ID %v deleted", id)
	c.JSON(http.StatusOK, map[string]interface{}{"message": message})

}
